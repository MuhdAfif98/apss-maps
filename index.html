<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-APSS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        apss: {
                            dark: '#0f172a',
                            darker: '#0a1022',
                            panel: '#1e293b',
                            border: '#334155',
                            accent: '#3b82f6',
                            red: '#ef4444',
                            orange: '#f97316',
                            green: '#22c55e',
                            amber: '#eab308',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: #0a1022;
        }
        
        .leaflet-container {
            background: #0f172a;
            font-family: 'Inter', sans-serif;
        }
        
        /* Dark map tiles */
        .leaflet-tile-pane {
            filter: brightness(0.6) saturate(0.3) hue-rotate(180deg) invert(1);
        }
        
        /* Custom popup */
        .leaflet-popup-content-wrapper {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
        }
        
        .leaflet-popup-tip {
            background: #1e293b;
            border: 1px solid #334155;
        }
        
        .leaflet-popup-content {
            margin: 0;
            font-family: 'Inter', sans-serif;
        }
        
        /* Zoom controls */
        .leaflet-control-zoom a {
            background: #1e293b !important;
            color: #e2e8f0 !important;
            border-color: #334155 !important;
        }
        
        .leaflet-control-zoom a:hover {
            background: #334155 !important;
        }
        
        /* Aircraft marker */
        .aircraft-icon {
            cursor: pointer;
        }
        
        .aircraft-icon:hover {
            filter: brightness(1.2);
        }
        
        /* Flight marker pulse */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        .marker-pulse {
            animation: pulse-ring 2s ease-out infinite;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
    </style>
</head>
<body class="min-h-screen font-sans text-gray-200 overflow-hidden">
    
    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-apss-dark border-b border-apss-border h-14 flex items-center px-6">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                </svg>
            </div>
            <div>
                <span class="text-lg font-semibold text-white">M-APSS</span>
                <span class="text-xs text-gray-500 ml-2">Live Map</span>
            </div>
        </div>
        
        <div class="ml-auto flex items-center gap-4">
            <div class="flex items-center gap-2">
                <span id="statusDot" class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                <span id="statusText" class="text-sm text-gray-400">Live</span>
            </div>
            <div id="lastUpdate" class="text-sm text-gray-500">--:--:--</div>
        </div>
    </header>
    
    <!-- Main Content -->
    <div class="pt-14 h-screen flex">
        
        <!-- Map Container -->
        <div class="flex-1 relative">
            <div id="map" class="absolute inset-0"></div>
            
            <!-- Live Statistics Panel (Top Right) -->
            <div class="absolute top-4 right-4 z-[1000] bg-apss-panel/95 backdrop-blur border border-apss-border rounded-lg p-4 min-w-[240px]">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-semibold text-white">Live Statistics</h3>
                    <span class="text-xs text-gray-500" id="currentDate">--</span>
                </div>
                
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Total Flights:</span>
                        <span id="aircraftCount" class="font-semibold text-white">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Active Alerts:</span>
                        <span id="alertCount" class="font-semibold text-apss-red">0</span>
                    </div>
                </div>
                
                <div class="mt-4 pt-3 border-t border-apss-border">
                    <div class="text-xs text-gray-500 uppercase tracking-wider mb-2">Auto Refresh</div>
                    <select id="refreshInterval" onchange="setRefreshInterval()" class="w-full bg-apss-dark border border-apss-border rounded px-2 py-1.5 text-sm text-gray-300 focus:border-apss-accent outline-none">
                        <option value="0">Off</option>
                        <option value="5000" selected>5 sec</option>
                        <option value="10000">10 sec</option>
                        <option value="30000">30 sec</option>
                    </select>
                </div>
            </div>
            
            <!-- Category Legend (Left Side) -->
            <div class="absolute top-4 left-4 z-[1000] bg-apss-panel/95 backdrop-blur border border-apss-border rounded-lg p-4 min-w-[180px]">
                <h3 class="text-sm font-semibold text-white mb-3">Categories</h3>
                
                <div class="space-y-2">
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" checked onchange="toggleCategory('normal')" class="w-3.5 h-3.5 rounded border-gray-600 bg-apss-dark text-apss-accent focus:ring-apss-accent focus:ring-offset-0">
                        <span class="w-2.5 h-2.5 rounded-full bg-apss-accent"></span>
                        <span class="text-sm text-gray-300 flex-1">Normal</span>
                        <span id="countNormal" class="text-xs text-gray-500">0</span>
                    </label>
                    
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" checked onchange="toggleCategory('whitelist')" class="w-3.5 h-3.5 rounded border-gray-600 bg-apss-dark text-green-500 focus:ring-green-500 focus:ring-offset-0">
                        <span class="w-2.5 h-2.5 rounded-full bg-apss-green"></span>
                        <span class="text-sm text-gray-300 flex-1">Whitelist</span>
                        <span id="countWhitelist" class="text-xs text-gray-500">0</span>
                    </label>
                    
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" checked onchange="toggleCategory('vip')" class="w-3.5 h-3.5 rounded border-gray-600 bg-apss-dark text-amber-500 focus:ring-amber-500 focus:ring-offset-0">
                        <span class="w-2.5 h-2.5 rounded-full bg-apss-amber"></span>
                        <span class="text-sm text-gray-300 flex-1">VIP</span>
                        <span id="countVip" class="text-xs text-gray-500">0</span>
                    </label>
                    
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" checked onchange="toggleCategory('suspect')" class="w-3.5 h-3.5 rounded border-gray-600 bg-apss-dark text-orange-500 focus:ring-orange-500 focus:ring-offset-0">
                        <span class="w-2.5 h-2.5 rounded-full bg-apss-orange"></span>
                        <span class="text-sm text-gray-300 flex-1">Suspect</span>
                        <span id="countSuspect" class="text-xs text-gray-500">0</span>
                    </label>
                    
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" checked onchange="toggleCategory('blacklist')" class="w-3.5 h-3.5 rounded border-gray-600 bg-apss-dark text-red-500 focus:ring-red-500 focus:ring-offset-0">
                        <span class="w-2.5 h-2.5 rounded-full bg-apss-red"></span>
                        <span class="text-sm text-gray-300 flex-1">Blacklist</span>
                        <span id="countBlacklist" class="text-xs text-gray-500">0</span>
                    </label>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Selected Flight Panel -->
    <div id="flightPanel" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[2000] bg-apss-panel border border-apss-border rounded-xl p-5 min-w-[500px] hidden shadow-2xl">
        <button onclick="closePanel()" class="absolute top-3 right-3 text-gray-500 hover:text-white transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
        
        <div class="flex items-start gap-5">
            <div class="flex-1">
                <!-- Header -->
                <div class="flex items-center gap-3 mb-4">
                    <div id="panelIcon" class="w-10 h-10 bg-apss-accent/20 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-apss-accent" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                        </svg>
                    </div>
                    <div>
                        <div class="flex items-center gap-2">
                            <span id="panelCallsign" class="text-lg font-bold text-white">---</span>
                            <span id="panelCategory" class="text-xs font-medium px-2 py-0.5 rounded">---</span>
                        </div>
                        <div class="flex items-center gap-2 text-sm text-gray-400">
                            <span id="panelCountry">---</span>
                            <span>•</span>
                            <span id="panelIcao" class="font-mono text-apss-accent">---</span>
                        </div>
                    </div>
                </div>
                
                <!-- Person Info (only for non-normal) -->
                <div id="panelPersonRow" class="mb-4 hidden">
                    <div id="panelPersonBox" class="rounded-lg p-3 border">
                        <div class="flex items-center gap-2 mb-1">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                            <span id="panelPersonLabel" class="text-xs font-medium uppercase">Person</span>
                        </div>
                        <div id="panelPersonName" class="font-semibold">---</div>
                        <div id="panelPersonReason" class="text-sm mt-1 opacity-80">---</div>
                    </div>
                </div>
                
                <!-- Flight Data Grid -->
                <div class="grid grid-cols-4 gap-3">
                    <div class="bg-apss-dark rounded-lg p-2.5">
                        <div class="text-[10px] text-gray-500 uppercase">Altitude</div>
                        <div id="panelAltitude" class="text-sm font-semibold text-white">---</div>
                    </div>
                    <div class="bg-apss-dark rounded-lg p-2.5">
                        <div class="text-[10px] text-gray-500 uppercase">Speed</div>
                        <div id="panelSpeed" class="text-sm font-semibold text-white">---</div>
                    </div>
                    <div class="bg-apss-dark rounded-lg p-2.5">
                        <div class="text-[10px] text-gray-500 uppercase">Heading</div>
                        <div id="panelHeading" class="text-sm font-semibold text-white">---</div>
                    </div>
                    <div class="bg-apss-dark rounded-lg p-2.5">
                        <div class="text-[10px] text-gray-500 uppercase">V/Rate</div>
                        <div id="panelVRate" class="text-sm font-semibold text-white">---</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 z-[3000] bg-apss-darker flex items-center justify-center">
        <div class="text-center">
            <div class="w-12 h-12 border-2 border-apss-accent border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-apss-accent font-medium">Loading M-APSS Data</p>
            <p class="text-gray-500 text-sm mt-1">Connecting to data source...</p>
        </div>
    </div>

    <script>
        // Map initialization - Malaysia focus
        const map = L.map('map', {
            center: [4.5, 109],
            zoom: 6,
            zoomControl: false,
            attributionControl: false
        });
        
        // Dark map tiles
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19
        }).addTo(map);
        
        // Add zoom control to bottom right
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        
        // Aircraft markers layer
        let aircraftLayer = L.layerGroup().addTo(map);
        let refreshTimer = null;
        let selectedFlight = null;
        
        // Category visibility
        const categoryVisibility = {
            normal: true,
            whitelist: true,
            vip: true,
            suspect: true,
            blacklist: true
        };
        
        // Category colors matching APSS theme
        const categoryColors = {
            normal: '#3b82f6',      // blue
            whitelist: '#22c55e',   // green
            vip: '#eab308',         // amber
            suspect: '#f97316',     // orange
            blacklist: '#ef4444'    // red
        };
        
        const categoryLabels = {
            normal: 'Normal',
            whitelist: 'Whitelist',
            vip: 'VIP',
            suspect: 'Suspect',
            blacklist: 'Blacklist'
        };
        
        const categoryStyles = {
            normal: 'bg-blue-500/20 text-blue-400 border-blue-500/30',
            whitelist: 'bg-green-500/20 text-green-400 border-green-500/30',
            vip: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
            suspect: 'bg-orange-500/20 text-orange-400 border-orange-500/30',
            blacklist: 'bg-red-500/20 text-red-400 border-red-500/30'
        };
        
        // Simulated flight category database
        const flightCategories = {};
        
        // Dummy persons for each category
        const dummyPersons = {
            whitelist: [
                { name: 'Ahmad Razali', reason: 'Verified government official' },
                { name: 'Dr. Siti Aminah', reason: 'Ministry of Health advisor' },
                { name: 'Tan Wei Ming', reason: 'Authorized diplomatic courier' },
                { name: 'Kamal Ariffin', reason: 'Approved military personnel' },
                { name: 'Lim Chee Kiang', reason: 'Registered airline executive' },
                { name: 'Mohd Faizal', reason: 'Cleared customs officer' },
                { name: 'Nurul Izzah', reason: 'Authorized press correspondent' },
                { name: 'Rajesh Kumar', reason: 'Verified medical transport' },
                { name: 'Hafizah Yusof', reason: 'Approved humanitarian worker' },
                { name: 'David Wong', reason: 'Registered cargo operator' }
            ],
            vip: [
                { name: 'Sultan Ibrahim', reason: 'Sultan of Johor' },
                { name: 'Tunku Ismail', reason: 'Crown Prince of Johor' },
                { name: 'Dato Sri Anwar', reason: 'Prime Minister of Malaysia' },
                { name: 'Tan Sri Robert Kuok', reason: 'Business tycoon' },
                { name: 'Dato Lee Chong Wei', reason: 'National sports hero' },
                { name: 'Tengku Zafrul', reason: 'Finance Minister' },
                { name: 'Tan Sri Tony Fernandes', reason: 'AirAsia founder' },
                { name: 'Dato Seri Vida', reason: 'Celebrity businesswoman' },
                { name: 'Tun Dr. Mahathir', reason: 'Former Prime Minister' },
                { name: 'Sultan Nazrin Shah', reason: 'Sultan of Perak' }
            ],
            suspect: [
                { name: 'Rizal bin Osman', reason: 'Suspected document forgery' },
                { name: 'Chen Wei Long', reason: 'Under investigation for smuggling' },
                { name: 'Kumar Rajan', reason: 'Immigration overstay warrant' },
                { name: 'Ahmad Zulkifli', reason: 'Financial fraud investigation' },
                { name: 'Lee Ah Kow', reason: 'Suspected illegal goods transport' },
                { name: 'Muthu Samy', reason: 'Customs evasion suspect' },
                { name: 'Hassan Ibrahim', reason: 'Passport irregularity' },
                { name: 'Liew Chun Fai', reason: 'Money laundering inquiry' },
                { name: 'Azman Kassim', reason: 'Unlicensed cargo operations' },
                { name: 'Ravi Chandran', reason: 'Border crossing violation' }
            ],
            blacklist: [
                { name: 'Ali Hassan', reason: 'Bombing Kuala Lumpur in 2012' },
                { name: 'Mohammad Firdaus', reason: 'Convicted terrorism charges' },
                { name: 'Tan Boon Seng', reason: 'International drug trafficking' },
                { name: 'Ismail Jaafar', reason: 'Armed robbery fugitive' },
                { name: 'Wong Kam Fook', reason: 'Human trafficking syndicate leader' },
                { name: 'Abdullah Rahman', reason: 'Interpol Red Notice - Murder' },
                { name: 'Lim Keng Huat', reason: 'Organized crime syndicate' },
                { name: 'Rafiq Noordin', reason: 'Weapons smuggling conviction' },
                { name: 'Suresh Nair', reason: 'Fraud affecting national security' },
                { name: 'Zainuddin Mat', reason: 'Escaped maximum security prison' }
            ]
        };
        
        function getFlightCategory(icao24) {
            if (flightCategories[icao24]) {
                return flightCategories[icao24];
            }
            
            const rand = Math.random();
            let category, person = null;
            
            if (rand < 0.70) {
                category = 'normal';
            } else if (rand < 0.82) {
                category = 'whitelist';
                person = dummyPersons.whitelist[Math.floor(Math.random() * dummyPersons.whitelist.length)];
            } else if (rand < 0.90) {
                category = 'vip';
                person = dummyPersons.vip[Math.floor(Math.random() * dummyPersons.vip.length)];
            } else if (rand < 0.97) {
                category = 'suspect';
                person = dummyPersons.suspect[Math.floor(Math.random() * dummyPersons.suspect.length)];
            } else {
                category = 'blacklist';
                person = dummyPersons.blacklist[Math.floor(Math.random() * dummyPersons.blacklist.length)];
            }
            
            flightCategories[icao24] = { category, person };
            return flightCategories[icao24];
        }
        
        // Region bounds - Malaysia
        const regions = {
            malaysia: { center: [4.5, 109], zoom: 6, bounds: [0.8, 99, 7.5, 119.5] }
        };
        
        // Create aircraft icon for flights
        function createFlightIcon(heading, category, isSelected = false) {
            const color = categoryColors[category];
            const size = isSelected ? 26 : 20;
            const glow = category === 'blacklist' ? 'drop-shadow(0 0 8px rgba(239, 68, 68, 0.8))' : 
                         category === 'suspect' ? 'drop-shadow(0 0 6px rgba(249, 115, 22, 0.6))' :
                         category === 'vip' ? 'drop-shadow(0 0 4px rgba(234, 179, 8, 0.4))' :
                         'drop-shadow(0 2px 3px rgba(0,0,0,0.3))';
            
            return L.divIcon({
                html: `
                    <svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="${color}" style="transform: rotate(${(heading || 0) + 45}deg); filter: ${glow};">
                        <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                    </svg>
                `,
                className: 'aircraft-icon',
                iconSize: [size, size],
                iconAnchor: [size/2, size/2]
            });
        }
        
        // Toggle category visibility
        function toggleCategory(category) {
            categoryVisibility[category] = !categoryVisibility[category];
            refreshData();
        }
        
        // Persistent dummy flights storage
        let dummyFlightsData = null;
        let lastUpdateTime = null;
        
        // Initialize dummy flights once
        function initDummyFlights() {
            const airlines = ['MAS', 'AXM', 'MXD', 'FYS', 'ODB', 'XAX', 'BTK'];
            const countries = ['Malaysia', 'Singapore', 'Thailand', 'Indonesia', 'China', 'Australia', 'Japan'];
            const flights = [];
            
            const numFlights = 25 + Math.floor(Math.random() * 15);
            
            for (let i = 0; i < numFlights; i++) {
                const airline = airlines[Math.floor(Math.random() * airlines.length)];
                const flightNum = Math.floor(Math.random() * 9000) + 100;
                const callsign = `${airline}${flightNum}`;
                const icao24 = Math.random().toString(16).substr(2, 6);
                
                const lat = 1 + Math.random() * 6;
                const lon = 100 + Math.random() * 18;
                
                const altitude = Math.random() > 0.1 ? 5000 + Math.random() * 35000 : 0;
                const velocity = altitude > 0 ? 150 + Math.random() * 400 : 0;
                const track = Math.random() * 360;
                const vRate = altitude > 0 ? (Math.random() - 0.5) * 20 : 0;
                const onGround = altitude === 0;
                const country = countries[Math.floor(Math.random() * countries.length)];
                
                flights.push({
                    icao24,
                    callsign,
                    country,
                    lat,
                    lon,
                    altitude,
                    velocity,
                    track,
                    vRate,
                    onGround
                });
            }
            
            return flights;
        }
        
        function updateDummyFlights() {
            if (!dummyFlightsData) {
                dummyFlightsData = initDummyFlights();
                lastUpdateTime = Date.now();
                return getDummyFlightsAsStates();
            }
            
            const now = Date.now();
            const deltaSeconds = (now - lastUpdateTime) / 1000;
            lastUpdateTime = now;
            
            dummyFlightsData = dummyFlightsData.map(flight => {
                if (flight.onGround) return flight;
                
                const speedDegPerSec = (flight.velocity * 0.0003);
                const distance = speedDegPerSec * deltaSeconds;
                const headingRad = flight.track * (Math.PI / 180);
                
                let newLat = flight.lat + (distance * Math.cos(headingRad));
                let newLon = flight.lon + (distance * Math.sin(headingRad));
                
                const [lamin, lomin, lamax, lomax] = regions.malaysia.bounds;
                
                if (newLat < lamin || newLat > lamax || newLon < lomin || newLon > lomax) {
                    if (newLat < lamin) newLat = lamax - 0.5;
                    if (newLat > lamax) newLat = lamin + 0.5;
                    if (newLon < lomin) newLon = lomax - 0.5;
                    if (newLon > lomax) newLon = lomin + 0.5;
                    flight.track = Math.random() * 360;
                }
                
                return { ...flight, lat: newLat, lon: newLon };
            });
            
            return getDummyFlightsAsStates();
        }
        
        function getDummyFlightsAsStates() {
            return dummyFlightsData.map(f => [
                f.icao24, f.callsign, f.country, Date.now()/1000, Date.now()/1000,
                f.lon, f.lat, f.altitude * 0.3048, f.onGround,
                f.velocity * 0.514, f.track, f.vRate * 0.00508
            ]);
        }
        
        // OpenSky API credentials
        const OPENSKY_USERNAME = 'ceks98';
        const OPENSKY_PASSWORD = 'az8eOP6uVvbQDPrVo0wqrMvLPVZitXV7';
        
        async function fetchFlights() {
            const [lamin, lomin, lamax, lomax] = regions.malaysia.bounds;
            const apiUrl = `https://opensky-network.org/api/states/all?lamin=${lamin}&lomin=${lomin}&lamax=${lamax}&lomax=${lomax}`;
            const url = `https://corsproxy.io/?${encodeURIComponent(apiUrl)}`;
            
            try {
                console.log('Fetching from OpenSky API via proxy...');
                const response = await fetch(url);
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }
                
                const data = await response.json();
                const flights = data.states || [];
                
                if (flights.length === 0) {
                    console.log('No flights in Malaysia airspace, using simulated flights');
                    updateDataSourceStatus(false, 'No flights in area');
                    return updateDummyFlights();
                }
                
                dummyFlightsData = null;
                updateDataSourceStatus(true);
                console.log(`Fetched ${flights.length} real flights`);
                return flights;
            } catch (error) {
                console.error('Fetch error:', error.message);
                updateDataSourceStatus(false, error.message);
                return updateDummyFlights();
            }
        }
        
        function updateDataSourceStatus(isRealData, reason = '') {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (isRealData) {
                dot.className = 'w-2 h-2 bg-green-500 rounded-full animate-pulse';
                text.textContent = 'Live';
                text.className = 'text-sm text-green-400';
            } else {
                dot.className = 'w-2 h-2 bg-amber-500 rounded-full animate-pulse';
                text.textContent = 'Simulated';
                text.className = 'text-sm text-amber-400';
            }
            text.title = reason || '';
        }
        
        async function refreshData() {
            const flights = await fetchFlights();
            aircraftLayer.clearLayers();
            
            const counts = { normal: 0, whitelist: 0, vip: 0, suspect: 0, blacklist: 0 };
            let alertCount = 0;
            
            flights.forEach(state => {
                const [icao24, callsign, country, timePos, lastContact, lon, lat, baroAlt, onGround, velocity, track, vRate] = state;
                
                if (lat && lon) {
                    const { category, person } = getFlightCategory(icao24);
                    counts[category]++;
                    
                    if (category === 'blacklist' || category === 'suspect') {
                        alertCount++;
                    }
                    
                    if (!categoryVisibility[category]) return;
                    
                    const isSelected = selectedFlight && selectedFlight.icao24 === icao24;
                    const heading = track ? track : 0;
                    
                    const flightData = {
                        icao24,
                        callsign: callsign?.trim() || 'N/A',
                        country: country || 'Unknown',
                        category,
                        personName: person?.name || null,
                        personReason: person?.reason || null,
                        lat,
                        lon,
                        altitude: baroAlt ? Math.round(baroAlt * 3.28084) : null,
                        speed: velocity ? Math.round(velocity * 1.94384) : null,
                        heading: track ? Math.round(track) : null,
                        vRate: vRate ? Math.round(vRate * 196.85) : null,
                        onGround
                    };
                    
                    const marker = L.marker([lat, lon], {
                        icon: createFlightIcon(heading, category, isSelected),
                        zIndexOffset: category === 'blacklist' ? 1000 : category === 'suspect' ? 500 : 0
                    });
                    
                    marker.on('click', () => selectFlight(flightData));
                    
                    const categoryBadge = `<span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-medium ${categoryStyles[category]}">${categoryLabels[category]}</span>`;
                    
                    marker.bindTooltip(`
                        <div class="p-2">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-white">${flightData.callsign}</span>
                                ${categoryBadge}
                            </div>
                            <div class="text-xs text-gray-400">${flightData.altitude ? flightData.altitude.toLocaleString() + ' ft' : 'Ground'}</div>
                        </div>
                    `, { direction: 'top', offset: [0, -10] });
                    
                    aircraftLayer.addLayer(marker);
                    
                    if (isSelected) {
                        updatePanel(flightData);
                    }
                }
            });
            
            // Update stats
            document.getElementById('aircraftCount').textContent = flights.length;
            document.getElementById('alertCount').textContent = alertCount;
            document.getElementById('countNormal').textContent = counts.normal;
            document.getElementById('countWhitelist').textContent = counts.whitelist;
            document.getElementById('countVip').textContent = counts.vip;
            document.getElementById('countSuspect').textContent = counts.suspect;
            document.getElementById('countBlacklist').textContent = counts.blacklist;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-GB');
            
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        function selectFlight(flightData) {
            selectedFlight = flightData;
            updatePanel(flightData);
            document.getElementById('flightPanel').classList.remove('hidden');
            map.panTo([flightData.lat, flightData.lon]);
            refreshData();
        }
        
        function updatePanel(data) {
            document.getElementById('panelCallsign').textContent = data.callsign;
            document.getElementById('panelCountry').textContent = data.country;
            document.getElementById('panelIcao').textContent = data.icao24.toUpperCase();
            document.getElementById('panelAltitude').textContent = data.altitude ? `${data.altitude.toLocaleString()} ft` : 'Ground';
            document.getElementById('panelSpeed').textContent = data.speed ? `${data.speed} kts` : '---';
            document.getElementById('panelHeading').textContent = data.heading !== null ? `${data.heading}°` : '---';
            document.getElementById('panelVRate').textContent = data.vRate ? `${data.vRate > 0 ? '+' : ''}${data.vRate}` : '---';
            
            // Category badge
            const categoryEl = document.getElementById('panelCategory');
            categoryEl.textContent = categoryLabels[data.category];
            categoryEl.className = `text-xs font-medium px-2 py-0.5 rounded ${categoryStyles[data.category]}`;
            
            // Person info
            const personRow = document.getElementById('panelPersonRow');
            const personBox = document.getElementById('panelPersonBox');
            const personLabel = document.getElementById('panelPersonLabel');
            const personNameEl = document.getElementById('panelPersonName');
            const personReasonEl = document.getElementById('panelPersonReason');
            
            if (data.personName) {
                personRow.classList.remove('hidden');
                personNameEl.textContent = data.personName;
                personReasonEl.textContent = data.personReason;
                
                const personStyles = {
                    whitelist: { box: 'bg-green-500/10 border-green-500/30 text-green-400', label: 'Whitelisted' },
                    vip: { box: 'bg-amber-500/10 border-amber-500/30 text-amber-400', label: 'VIP' },
                    suspect: { box: 'bg-orange-500/10 border-orange-500/30 text-orange-400', label: 'Suspect' },
                    blacklist: { box: 'bg-red-500/10 border-red-500/30 text-red-400', label: 'Blacklisted' }
                };
                
                const style = personStyles[data.category];
                personBox.className = `rounded-lg p-3 border ${style.box}`;
                personLabel.textContent = style.label;
            } else {
                personRow.classList.add('hidden');
            }
            
            // Icon color
            const iconEl = document.getElementById('panelIcon');
            const iconColors = {
                normal: 'bg-blue-500/20 text-blue-400',
                whitelist: 'bg-green-500/20 text-green-400',
                vip: 'bg-amber-500/20 text-amber-400',
                suspect: 'bg-orange-500/20 text-orange-400',
                blacklist: 'bg-red-500/20 text-red-400'
            };
            iconEl.className = `w-10 h-10 ${iconColors[data.category]} rounded-lg flex items-center justify-center`;
        }
        
        function closePanel() {
            document.getElementById('flightPanel').classList.add('hidden');
            selectedFlight = null;
            refreshData();
        }
        
        function setRefreshInterval() {
            const interval = parseInt(document.getElementById('refreshInterval').value);
            
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
            }
            
            if (interval > 0) {
                refreshTimer = setInterval(refreshData, interval);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            refreshData();
            setRefreshInterval();
        });
    </script>
</body>
</html>
