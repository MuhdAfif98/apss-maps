<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Flight Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['DM Sans', 'sans-serif'],
                    },
                    colors: {
                        sky: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f8fafc 100%);
        }
        
        .leaflet-container {
            font-family: 'DM Sans', sans-serif;
        }
        
        /* Aircraft marker */
        .aircraft-marker {
            transition: transform 0.2s ease;
        }
        
        .aircraft-marker:hover {
            transform: scale(1.2);
        }
        
        /* Custom popup */
        .leaflet-popup-content-wrapper {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .leaflet-popup-tip {
            background: white;
        }
        
        .leaflet-popup-content {
            margin: 0;
            font-family: 'DM Sans', sans-serif;
        }
        
        /* Card shadows */
        .card-shadow {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        /* Smooth animations */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        
        .float-animation {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes pulse-border {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1); }
        }
        
        .pulse-danger {
            animation: pulse-border 2s ease-in-out infinite;
        }
    </style>
</head>
<body class="min-h-screen font-sans text-gray-800 overflow-hidden">
    
    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-white/90 backdrop-blur-md border-b border-gray-200">
        <div class="flex items-center justify-between px-6 py-3">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-sky-500 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900">Flight Tracker</h1>
                    <p class="text-xs text-sky-600 font-medium">Real-time Aviation Data</p>
                </div>
            </div>
            
            <!-- Status -->
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-2">
                    <span id="statusDot" class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span id="statusText" class="text-sm font-medium text-gray-600">Live</span>
                </div>
                <div id="lastUpdate" class="text-sm text-gray-500">--:--:--</div>
            </div>
        </div>
    </header>
    
    <!-- Stats Bar -->
    <div class="fixed top-20 left-6 z-40 flex flex-col gap-3 max-h-[calc(100vh-120px)] overflow-y-auto">
        <div class="card-shadow bg-white rounded-xl px-4 py-3 border border-gray-100">
            <div class="text-xs text-gray-500 font-medium uppercase tracking-wider">Aircraft Tracked</div>
            <div id="aircraftCount" class="text-2xl font-bold text-sky-600">0</div>
        </div>
        <div class="card-shadow bg-white rounded-xl px-4 py-3 border border-gray-100">
            <div class="text-xs text-gray-500 font-medium uppercase tracking-wider">Coverage</div>
            <div class="text-lg font-semibold text-gray-800">Asia</div>
        </div>
        
        <!-- Category Legend -->
        <div class="card-shadow bg-white rounded-xl px-4 py-3 border border-gray-100">
            <div class="text-xs text-gray-500 font-medium uppercase tracking-wider mb-3">Categories</div>
            
            <label class="flex items-center gap-3 py-2 cursor-pointer hover:bg-gray-50 -mx-2 px-2 rounded-lg">
                <input type="checkbox" checked onchange="toggleCategory('normal')" class="w-4 h-4 rounded text-sky-500 focus:ring-sky-400">
                <span class="w-3 h-3 rounded-full bg-sky-500"></span>
                <span class="text-sm text-gray-700 flex-1">Normal</span>
                <span id="countNormal" class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">0</span>
            </label>
            
            <label class="flex items-center gap-3 py-2 cursor-pointer hover:bg-gray-50 -mx-2 px-2 rounded-lg">
                <input type="checkbox" checked onchange="toggleCategory('whitelist')" class="w-4 h-4 rounded text-emerald-500 focus:ring-emerald-400">
                <span class="w-3 h-3 rounded-full bg-emerald-500"></span>
                <span class="text-sm text-gray-700 flex-1">Whitelist</span>
                <span id="countWhitelist" class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">0</span>
            </label>
            
            <label class="flex items-center gap-3 py-2 cursor-pointer hover:bg-gray-50 -mx-2 px-2 rounded-lg">
                <input type="checkbox" checked onchange="toggleCategory('vip')" class="w-4 h-4 rounded text-amber-500 focus:ring-amber-400">
                <span class="w-3 h-3 rounded-full bg-amber-500"></span>
                <span class="text-sm text-gray-700 flex-1">VIP</span>
                <span id="countVip" class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">0</span>
            </label>
            
            <label class="flex items-center gap-3 py-2 cursor-pointer hover:bg-gray-50 -mx-2 px-2 rounded-lg">
                <input type="checkbox" checked onchange="toggleCategory('suspect')" class="w-4 h-4 rounded text-orange-500 focus:ring-orange-400">
                <span class="w-3 h-3 rounded-full bg-orange-500"></span>
                <span class="text-sm text-gray-700 flex-1">Suspect</span>
                <span id="countSuspect" class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">0</span>
            </label>
            
            <label class="flex items-center gap-3 py-2 cursor-pointer hover:bg-gray-50 -mx-2 px-2 rounded-lg">
                <input type="checkbox" checked onchange="toggleCategory('blacklist')" class="w-4 h-4 rounded text-red-500 focus:ring-red-400">
                <span class="w-3 h-3 rounded-full bg-red-600"></span>
                <span class="text-sm text-gray-700 flex-1">Blacklist</span>
                <span id="countBlacklist" class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">0</span>
            </label>
        </div>
    </div>
    
    <!-- Controls -->
    <div class="fixed top-20 right-6 z-40 flex flex-col gap-3">
        <button onclick="refreshData()" class="card-shadow bg-white rounded-xl px-4 py-3 border border-gray-100 hover:bg-sky-50 hover:border-sky-200 transition-all group">
            <div class="flex items-center gap-2">
                <svg id="refreshIcon" class="w-5 h-5 text-sky-600 group-hover:rotate-180 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <span class="text-sm font-medium text-gray-700">Refresh</span>
            </div>
        </button>
        
        <div class="card-shadow bg-white rounded-xl px-4 py-3 border border-gray-100">
            <label class="text-xs text-gray-500 font-medium uppercase tracking-wider block mb-2">Auto Refresh</label>
            <select id="refreshInterval" onchange="setRefreshInterval()" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-1.5 text-sm focus:border-sky-400 focus:ring-2 focus:ring-sky-100 outline-none transition-all">
                <option value="0">Off</option>
                <option value="5000" selected>5 sec</option>
                <option value="10000">10 sec</option>
                <option value="30000">30 sec</option>
                <option value="60000">1 min</option>
            </select>
        </div>
        
    </div>
    
    <!-- Map Container -->
    <div id="map" class="fixed inset-0 z-10"></div>
    
    <!-- Selected Flight Panel -->
    <div id="flightPanel" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 bg-white card-shadow rounded-2xl p-6 min-w-[480px] border border-gray-100 hidden">
        <button onclick="closePanel()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
        
        <div class="flex items-start gap-6">
            <div class="flex-1">
                <div class="flex items-center gap-3 mb-4">
                    <div id="panelIcon" class="w-10 h-10 bg-sky-100 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-sky-600" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                        </svg>
                    </div>
                    <div>
                        <span id="panelCallsign" class="text-xl font-bold text-gray-900">---</span>
                        <span id="panelCountry" class="ml-2 text-sm text-gray-500 px-2 py-0.5 bg-gray-100 rounded-full">---</span>
                    </div>
                    <span id="panelCategory" class="ml-auto text-sm font-semibold px-3 py-1 rounded-full">---</span>
                </div>
                
                <!-- Person Info (only shown for non-normal) -->
                <div id="panelPersonRow" class="mb-3 hidden">
                    <div id="panelPersonBox" class="rounded-lg p-3 border-2">
                        <div class="flex items-start justify-between gap-4">
                            <div class="flex-1">
                                <div class="text-xs font-medium uppercase mb-1" id="panelPersonLabel">Person</div>
                                <div id="panelPersonName" class="text-base font-bold">---</div>
                            </div>
                        </div>
                        <div class="mt-2 pt-2 border-t border-current/10">
                            <div class="text-xs font-medium uppercase mb-1 opacity-70">Reason</div>
                            <div id="panelPersonReason" class="text-sm">---</div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-xs text-gray-500 font-medium uppercase">Altitude</div>
                        <div id="panelAltitude" class="text-lg font-semibold text-gray-800">--- ft</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-xs text-gray-500 font-medium uppercase">Speed</div>
                        <div id="panelSpeed" class="text-lg font-semibold text-gray-800">--- kts</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-xs text-gray-500 font-medium uppercase">Heading</div>
                        <div id="panelHeading" class="text-lg font-semibold text-gray-800">---°</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-xs text-gray-500 font-medium uppercase">Vertical Rate</div>
                        <div id="panelVRate" class="text-lg font-semibold text-gray-800">--- ft/m</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-xs text-gray-500 font-medium uppercase">ICAO24</div>
                        <div id="panelIcao" class="text-lg font-semibold text-sky-600">---</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-xs text-gray-500 font-medium uppercase">On Ground</div>
                        <div id="panelGround" class="text-lg font-semibold text-gray-800">---</div>
                    </div>
                </div>
            </div>
            
            <!-- Heading indicator -->
            <div class="relative w-20 h-20 bg-gray-50 rounded-full border-2 border-gray-200">
                <div class="absolute inset-0 flex items-center justify-center text-[10px] font-medium text-gray-400">
                    <span class="absolute top-1.5">N</span>
                    <span class="absolute bottom-1.5">S</span>
                    <span class="absolute left-1.5">W</span>
                    <span class="absolute right-1.5">E</span>
                </div>
                <div id="compassNeedle" class="absolute top-1/2 left-1/2 w-0.5 h-7 bg-sky-500 origin-bottom -translate-x-1/2 rounded-full" style="transform-origin: bottom center;"></div>
                <div class="absolute top-1/2 left-1/2 w-2 h-2 bg-sky-500 rounded-full -translate-x-1/2 -translate-y-1/2"></div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 z-[100] bg-white flex items-center justify-center">
        <div class="text-center">
            <div class="w-16 h-16 mx-auto mb-4 float-animation">
                <svg class="w-full h-full text-sky-500" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                </svg>
            </div>
            <p class="text-sky-600 font-semibold text-lg">Loading Flight Data</p>
            <p class="text-gray-500 text-sm mt-1">Connecting to OpenSky Network...</p>
        </div>
    </div>

    <script>
        // Map initialization
        const map = L.map('map', {
            center: [25, 105],
            zoom: 4,
            zoomControl: false,
            attributionControl: false
        });
        
        // Light map tiles
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19
        }).addTo(map);
        
        // Add zoom control to bottom right
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        
        // Aircraft markers layer
        let aircraftLayer = L.layerGroup().addTo(map);
        let refreshTimer = null;
        let selectedFlight = null;
        
        // Category visibility
        const categoryVisibility = {
            normal: true,
            whitelist: true,
            vip: true,
            suspect: true,
            blacklist: true
        };
        
        // Category colors
        const categoryColors = {
            normal: '#0284c7',      // sky-600
            whitelist: '#10b981',   // emerald-500
            vip: '#f59e0b',         // amber-500
            suspect: '#f97316',     // orange-500
            blacklist: '#dc2626'    // red-600
        };
        
        const categoryLabels = {
            normal: 'Normal',
            whitelist: 'Whitelist',
            vip: 'VIP',
            suspect: 'Suspect',
            blacklist: 'Blacklist'
        };
        
        const categoryBgColors = {
            normal: 'bg-sky-100 text-sky-700',
            whitelist: 'bg-emerald-100 text-emerald-700',
            vip: 'bg-amber-100 text-amber-700',
            suspect: 'bg-orange-100 text-orange-700',
            blacklist: 'bg-red-100 text-red-700'
        };
        
        // Simulated flight category database (randomized per session)
        // In real app, this would come from backend
        const flightCategories = {};
        
        // Dummy persons for each category with name and reason
        const dummyPersons = {
            whitelist: [
                { name: 'Ahmad Razali', reason: 'Verified government official' },
                { name: 'Dr. Siti Aminah', reason: 'Ministry of Health advisor' },
                { name: 'Tan Wei Ming', reason: 'Authorized diplomatic courier' },
                { name: 'Kamal Ariffin', reason: 'Approved military personnel' },
                { name: 'Lim Chee Kiang', reason: 'Registered airline executive' },
                { name: 'Mohd Faizal', reason: 'Cleared customs officer' },
                { name: 'Nurul Izzah', reason: 'Authorized press correspondent' },
                { name: 'Rajesh Kumar', reason: 'Verified medical transport' },
                { name: 'Hafizah Yusof', reason: 'Approved humanitarian worker' },
                { name: 'David Wong', reason: 'Registered cargo operator' }
            ],
            vip: [
                { name: 'Sultan Ibrahim', reason: 'Sultan of Johor' },
                { name: 'Tunku Ismail', reason: 'Crown Prince of Johor' },
                { name: 'Dato Sri Anwar', reason: 'Prime Minister of Malaysia' },
                { name: 'Tan Sri Robert Kuok', reason: 'Business tycoon' },
                { name: 'Dato Lee Chong Wei', reason: 'National sports hero' },
                { name: 'Tengku Zafrul', reason: 'Finance Minister' },
                { name: 'Tan Sri Tony Fernandes', reason: 'AirAsia founder' },
                { name: 'Dato Seri Vida', reason: 'Celebrity businesswoman' },
                { name: 'Tun Dr. Mahathir', reason: 'Former Prime Minister' },
                { name: 'Sultan Nazrin Shah', reason: 'Sultan of Perak' }
            ],
            suspect: [
                { name: 'Rizal bin Osman', reason: 'Suspected document forgery' },
                { name: 'Chen Wei Long', reason: 'Under investigation for smuggling' },
                { name: 'Kumar Rajan', reason: 'Immigration overstay warrant' },
                { name: 'Ahmad Zulkifli', reason: 'Financial fraud investigation' },
                { name: 'Lee Ah Kow', reason: 'Suspected illegal goods transport' },
                { name: 'Muthu Samy', reason: 'Customs evasion suspect' },
                { name: 'Hassan Ibrahim', reason: 'Passport irregularity' },
                { name: 'Liew Chun Fai', reason: 'Money laundering inquiry' },
                { name: 'Azman Kassim', reason: 'Unlicensed cargo operations' },
                { name: 'Ravi Chandran', reason: 'Border crossing violation' }
            ],
            blacklist: [
                { name: 'Ali Hassan', reason: 'Bombing Kuala Lumpur in 2012' },
                { name: 'Mohammad Firdaus', reason: 'Convicted terrorism charges' },
                { name: 'Tan Boon Seng', reason: 'International drug trafficking' },
                { name: 'Ismail Jaafar', reason: 'Armed robbery fugitive' },
                { name: 'Wong Kam Fook', reason: 'Human trafficking syndicate leader' },
                { name: 'Abdullah Rahman', reason: 'Interpol Red Notice - Murder' },
                { name: 'Lim Keng Huat', reason: 'Organized crime syndicate' },
                { name: 'Rafiq Noordin', reason: 'Weapons smuggling conviction' },
                { name: 'Suresh Nair', reason: 'Fraud affecting national security' },
                { name: 'Zainuddin Mat', reason: 'Escaped maximum security prison' }
            ]
        };
        
        function getFlightCategory(icao24) {
            // Check if already assigned
            if (flightCategories[icao24]) {
                return flightCategories[icao24];
            }
            
            // Random assignment with weighted distribution
            // 70% normal, 12% whitelist, 8% vip, 7% suspect, 3% blacklist
            const rand = Math.random();
            let category, person = null;
            
            if (rand < 0.70) {
                category = 'normal';
            } else if (rand < 0.82) {
                category = 'whitelist';
                person = dummyPersons.whitelist[Math.floor(Math.random() * dummyPersons.whitelist.length)];
            } else if (rand < 0.90) {
                category = 'vip';
                person = dummyPersons.vip[Math.floor(Math.random() * dummyPersons.vip.length)];
            } else if (rand < 0.97) {
                category = 'suspect';
                person = dummyPersons.suspect[Math.floor(Math.random() * dummyPersons.suspect.length)];
            } else {
                category = 'blacklist';
                person = dummyPersons.blacklist[Math.floor(Math.random() * dummyPersons.blacklist.length)];
            }
            
            flightCategories[icao24] = { category, person };
            return flightCategories[icao24];
        }
        
        // Region bounds - Asia
        const regions = {
            asia: { center: [25, 105], zoom: 4, bounds: [-10, 60, 55, 150] }
        };
        
        // Create aircraft icon with category color
        function createAircraftIcon(heading, category, isSelected = false) {
            const color = isSelected ? '#1f2937' : categoryColors[category];
            const size = isSelected ? 28 : 22;
            const glow = category === 'blacklist' ? 'filter: drop-shadow(0 0 6px rgba(220, 38, 38, 0.6));' : 
                         category === 'suspect' ? 'filter: drop-shadow(0 0 4px rgba(249, 115, 22, 0.5));' :
                         'filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));';
            
            return L.divIcon({
                html: `
                    <svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="${color}" class="aircraft-marker" style="transform: rotate(${(heading || 0) + 45}deg); ${glow}">
                        <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                    </svg>
                `,
                className: '',
                iconSize: [size, size],
                iconAnchor: [size/2, size/2]
            });
        }
        
        // Toggle category visibility
        function toggleCategory(category) {
            categoryVisibility[category] = !categoryVisibility[category];
            refreshData();
        }
        
        // Persistent dummy flights storage
        let dummyFlightsData = null;
        let lastUpdateTime = null;
        
        // Initialize dummy flights once
        function initDummyFlights() {
            const airlines = ['MAS', 'AXM', 'SIA', 'CPA', 'JAL', 'ANA', 'KAL', 'CES', 'CSN', 'THA', 'VNA', 'GIA', 'PAL', 'EVA', 'CAL', 'QTR', 'UAE', 'ETD', 'SLK', 'AIJ'];
            const countries = ['Malaysia', 'Singapore', 'Thailand', 'Indonesia', 'China', 'Japan', 'South Korea', 'India', 'Vietnam', 'Philippines', 'Taiwan', 'Hong Kong', 'UAE', 'Qatar', 'Australia'];
            const flights = [];
            
            // Generate 80-120 random flights across Asia
            const numFlights = 80 + Math.floor(Math.random() * 40);
            
            for (let i = 0; i < numFlights; i++) {
                const airline = airlines[Math.floor(Math.random() * airlines.length)];
                const flightNum = Math.floor(Math.random() * 9000) + 100;
                const callsign = `${airline}${flightNum}`;
                const icao24 = Math.random().toString(16).substr(2, 6);
                
                // Random position within Asia bounds
                const lat = -10 + Math.random() * 65; // -10 to 55
                const lon = 60 + Math.random() * 90; // 60 to 150
                
                const altitude = Math.random() > 0.1 ? 5000 + Math.random() * 35000 : 0; // 10% on ground
                const velocity = altitude > 0 ? 150 + Math.random() * 400 : 0; // knots
                const track = Math.random() * 360;
                const vRate = altitude > 0 ? (Math.random() - 0.5) * 20 : 0;
                const onGround = altitude === 0;
                const country = countries[Math.floor(Math.random() * countries.length)];
                
                flights.push({
                    icao24,
                    callsign,
                    country,
                    lat,
                    lon,
                    altitude, // feet
                    velocity, // knots
                    track,    // degrees
                    vRate,    // ft/min
                    onGround
                });
            }
            
            return flights;
        }
        
        // Update flight positions based on elapsed time
        function updateDummyFlights() {
            if (!dummyFlightsData) {
                dummyFlightsData = initDummyFlights();
                lastUpdateTime = Date.now();
                return getDummyFlightsAsStates();
            }
            
            const now = Date.now();
            const deltaSeconds = (now - lastUpdateTime) / 1000;
            lastUpdateTime = now;
            
            // Update each flight position
            dummyFlightsData = dummyFlightsData.map(flight => {
                if (flight.onGround) return flight;
                
                // Calculate movement based on heading and speed
                // 1 knot ≈ 0.0003 degrees per second at equator
                const speedDegPerSec = (flight.velocity * 0.0003);
                const distance = speedDegPerSec * deltaSeconds;
                
                // Convert heading to radians
                const headingRad = flight.track * (Math.PI / 180);
                
                // Update position
                let newLat = flight.lat + (distance * Math.cos(headingRad));
                let newLon = flight.lon + (distance * Math.sin(headingRad));
                
                // Check bounds - if out of Malaysia, wrap around or reverse
                const [lamin, lomin, lamax, lomax] = regions.asia.bounds;
                
                if (newLat < lamin || newLat > lamax || newLon < lomin || newLon > lomax) {
                    // Re-enter from opposite side or random edge
                    if (newLat < lamin) newLat = lamax - 0.5;
                    if (newLat > lamax) newLat = lamin + 0.5;
                    if (newLon < lomin) newLon = lomax - 0.5;
                    if (newLon > lomax) newLon = lomin + 0.5;
                    
                    // Randomize heading slightly when wrapping
                    flight.track = Math.random() * 360;
                }
                
                return {
                    ...flight,
                    lat: newLat,
                    lon: newLon
                };
            });
            
            return getDummyFlightsAsStates();
        }
        
        // Convert stored flights to OpenSky API format
        function getDummyFlightsAsStates() {
            return dummyFlightsData.map(f => [
                f.icao24,           // 0: icao24
                f.callsign,         // 1: callsign
                f.country,          // 2: origin_country
                Date.now()/1000,    // 3: time_position
                Date.now()/1000,    // 4: last_contact
                f.lon,              // 5: longitude
                f.lat,              // 6: latitude
                f.altitude * 0.3048,// 7: baro_altitude (convert ft to m)
                f.onGround,         // 8: on_ground
                f.velocity * 0.514, // 9: velocity (convert kts to m/s)
                f.track,            // 10: true_track
                f.vRate * 0.00508   // 11: vertical_rate (convert ft/min to m/s)
            ]);
        }
        
        // OpenSky API credentials
        const OPENSKY_USERNAME = 'ceks98';
        const OPENSKY_PASSWORD = 'az8eOP6uVvbQDPrVo0wqrMvLPVZitXV7';
        
        // Fetch flight data from OpenSky Network - Malaysia region
        async function fetchFlights() {
            const [lamin, lomin, lamax, lomax] = regions.asia.bounds;
            // Use CORS proxy for browser requests
            const apiUrl = `https://opensky-network.org/api/states/all?lamin=${lamin}&lomin=${lomin}&lamax=${lamax}&lomax=${lomax}`;
            const url = `https://corsproxy.io/?${encodeURIComponent(apiUrl)}`;
            
            // Create basic auth header
            const authHeader = 'Basic ' + btoa(`${OPENSKY_USERNAME}:${OPENSKY_PASSWORD}`);
            
            try {
                console.log('Fetching from OpenSky API via proxy...');
                // Note: CORS proxy may not forward auth headers, but provides higher rate limits anyway
                const response = await fetch(url);
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', response.status, errorText);
                    throw new Error(`API request failed: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('API Response:', data);
                const flights = data.states || [];
                
                // If no real flights, use simulated data
                if (flights.length === 0) {
                    console.log('No flights in Malaysia airspace, using simulated flights');
                    updateDataSourceStatus(false, 'No flights in area');
                    return updateDummyFlights();
                }
                
                // Clear dummy data if we have real flights
                dummyFlightsData = null;
                updateDataSourceStatus(true);
                console.log(`Fetched ${flights.length} real flights`);
                return flights;
            } catch (error) {
                console.error('Fetch error:', error.message);
                // Check if it's a CORS error
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    console.error('Likely CORS issue - browser blocking request');
                    updateDataSourceStatus(false, 'CORS blocked');
                } else {
                    updateDataSourceStatus(false, error.message);
                }
                return updateDummyFlights();
            }
        }
        
        // Update status indicator
        function updateDataSourceStatus(isRealData, reason = '') {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (isRealData) {
                dot.className = 'w-2 h-2 bg-green-500 rounded-full animate-pulse';
                text.textContent = 'Live';
                text.className = 'text-sm font-medium text-green-600';
                text.title = 'Real data from OpenSky Network';
            } else {
                dot.className = 'w-2 h-2 bg-amber-500 rounded-full animate-pulse';
                text.textContent = 'Simulated';
                text.className = 'text-sm font-medium text-amber-600';
                text.title = reason || 'Using simulated flight data';
            }
        }
        
        // Update map with flight data
        async function refreshData() {
            const refreshIcon = document.getElementById('refreshIcon');
            refreshIcon.classList.add('animate-spin');
            
            const flights = await fetchFlights();
            aircraftLayer.clearLayers();
            
            // Category counters
            const counts = { normal: 0, whitelist: 0, vip: 0, suspect: 0, blacklist: 0 };
            
            flights.forEach(state => {
                const [icao24, callsign, country, timePos, lastContact, lon, lat, baroAlt, onGround, velocity, track, vRate] = state;
                
                if (lat && lon) {
                    const { category, person } = getFlightCategory(icao24);
                    counts[category]++;
                    
                    // Skip if category is hidden
                    if (!categoryVisibility[category]) return;
                    
                    const isSelected = selectedFlight && selectedFlight.icao24 === icao24;
                    const marker = L.marker([lat, lon], {
                        icon: createAircraftIcon(track, category, isSelected),
                        zIndexOffset: category === 'blacklist' ? 1000 : category === 'suspect' ? 500 : 0
                    });
                    
                    const flightData = {
                        icao24,
                        callsign: callsign?.trim() || 'N/A',
                        country: country || 'Unknown',
                        category,
                        personName: person?.name || null,
                        personReason: person?.reason || null,
                        lat,
                        lon,
                        altitude: baroAlt ? Math.round(baroAlt * 3.28084) : null,
                        speed: velocity ? Math.round(velocity * 1.94384) : null,
                        heading: track ? Math.round(track) : null,
                        vRate: vRate ? Math.round(vRate * 196.85) : null,
                        onGround
                    };
                    
                    marker.on('click', () => selectFlight(flightData));
                    
                    const categoryBadge = `<span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-medium ${categoryBgColors[category]}">${categoryLabels[category]}</span>`;
                    
                    marker.bindTooltip(`
                        <div class="p-2">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-gray-800">${flightData.callsign}</span>
                                ${categoryBadge}
                            </div>
                            <div class="text-xs text-gray-500">${flightData.altitude ? flightData.altitude.toLocaleString() + ' ft' : 'Ground'}</div>
                        </div>
                    `, {
                        direction: 'top',
                        offset: [0, -10]
                    });
                    
                    aircraftLayer.addLayer(marker);
                    
                    if (isSelected) {
                        updatePanel(flightData);
                    }
                }
            });
            
            // Update counts in UI
            document.getElementById('aircraftCount').textContent = flights.length.toLocaleString();
            document.getElementById('countNormal').textContent = counts.normal;
            document.getElementById('countWhitelist').textContent = counts.whitelist;
            document.getElementById('countVip').textContent = counts.vip;
            document.getElementById('countSuspect').textContent = counts.suspect;
            document.getElementById('countBlacklist').textContent = counts.blacklist;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            
            refreshIcon.classList.remove('animate-spin');
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        function selectFlight(flightData) {
            selectedFlight = flightData;
            updatePanel(flightData);
            document.getElementById('flightPanel').classList.remove('hidden');
            map.panTo([flightData.lat, flightData.lon]);
            refreshData();
        }
        
        function updatePanel(data) {
            document.getElementById('panelCallsign').textContent = data.callsign;
            document.getElementById('panelCountry').textContent = data.country;
            document.getElementById('panelAltitude').textContent = data.altitude ? `${data.altitude.toLocaleString()} ft` : 'Ground';
            document.getElementById('panelSpeed').textContent = data.speed ? `${data.speed} kts` : '---';
            document.getElementById('panelHeading').textContent = data.heading !== null ? `${data.heading}°` : '---';
            document.getElementById('panelVRate').textContent = data.vRate ? `${data.vRate > 0 ? '+' : ''}${data.vRate} ft/m` : '---';
            document.getElementById('panelIcao').textContent = data.icao24.toUpperCase();
            document.getElementById('panelGround').textContent = data.onGround ? 'Yes' : 'No';
            
            // Update category badge
            const categoryEl = document.getElementById('panelCategory');
            categoryEl.textContent = categoryLabels[data.category];
            categoryEl.className = `ml-auto text-sm font-semibold px-3 py-1 rounded-full ${categoryBgColors[data.category]}`;
            
            // Update person info display
            const personRow = document.getElementById('panelPersonRow');
            const personBox = document.getElementById('panelPersonBox');
            const personLabel = document.getElementById('panelPersonLabel');
            const personNameEl = document.getElementById('panelPersonName');
            const personReasonEl = document.getElementById('panelPersonReason');
            
            if (data.personName) {
                personRow.classList.remove('hidden');
                personNameEl.textContent = data.personName;
                personReasonEl.textContent = data.personReason;
                
                // Style based on category
                const personStyles = {
                    whitelist: {
                        box: 'bg-emerald-50 border-emerald-200',
                        label: 'text-emerald-600',
                        name: 'text-emerald-800',
                        reason: 'text-emerald-700',
                        labelText: 'Whitelisted Person'
                    },
                    vip: {
                        box: 'bg-amber-50 border-amber-200',
                        label: 'text-amber-600',
                        name: 'text-amber-800',
                        reason: 'text-amber-700',
                        labelText: 'VIP Passenger'
                    },
                    suspect: {
                        box: 'bg-orange-50 border-orange-300',
                        label: 'text-orange-600',
                        name: 'text-orange-800',
                        reason: 'text-orange-700',
                        labelText: 'Suspect'
                    },
                    blacklist: {
                        box: 'bg-red-50 border-red-300',
                        label: 'text-red-600',
                        name: 'text-red-800',
                        reason: 'text-red-700',
                        labelText: 'Blacklisted Person'
                    }
                };
                
                const style = personStyles[data.category];
                personBox.className = `rounded-lg p-3 border-2 ${style.box}`;
                personLabel.className = `text-xs font-medium uppercase mb-1 ${style.label}`;
                personLabel.textContent = style.labelText;
                personNameEl.className = `text-base font-bold ${style.name}`;
                personReasonEl.className = `text-sm ${style.reason}`;
            } else {
                personRow.classList.add('hidden');
            }
            
            // Update icon background based on category
            const iconEl = document.getElementById('panelIcon');
            const iconBg = {
                normal: 'bg-sky-100',
                whitelist: 'bg-emerald-100',
                vip: 'bg-amber-100',
                suspect: 'bg-orange-100',
                blacklist: 'bg-red-100'
            };
            const iconText = {
                normal: 'text-sky-600',
                whitelist: 'text-emerald-600',
                vip: 'text-amber-600',
                suspect: 'text-orange-600',
                blacklist: 'text-red-600'
            };
            iconEl.className = `w-10 h-10 ${iconBg[data.category]} rounded-full flex items-center justify-center`;
            iconEl.querySelector('svg').className = `w-5 h-5 ${iconText[data.category]}`;
            
            // Pulse effect for dangerous categories
            const panelEl = document.getElementById('flightPanel');
            if (data.category === 'blacklist') {
                panelEl.classList.add('pulse-danger', 'border-red-200');
            } else {
                panelEl.classList.remove('pulse-danger', 'border-red-200');
            }
            
            const needle = document.getElementById('compassNeedle');
            needle.style.transform = `translateX(-50%) rotate(${data.heading || 0}deg)`;
        }
        
        function closePanel() {
            document.getElementById('flightPanel').classList.add('hidden');
            selectedFlight = null;
            refreshData();
        }
        
        function setRefreshInterval() {
            const interval = parseInt(document.getElementById('refreshInterval').value);
            
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
            }
            
            if (interval > 0) {
                refreshTimer = setInterval(refreshData, interval);
            }
        }
        
        
        document.addEventListener('DOMContentLoaded', () => {
            refreshData();
            setRefreshInterval();
        });
    </script>
</body>
</html>
